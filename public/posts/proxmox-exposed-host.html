<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel=stylesheet type="text/css" href="../css/style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta NAME="language" CONTENT="en">
        <meta name="keywords" content="tinfoilhat, tinfoil-hat, Conspiracy Theories, Linux, Opensource, IT, computer science, Unix, vlog, [★]">
        <meta name="description" content="IT-Blog: Tinfoil-hat.net, tinfoilhat, tinfoil-hat, Conspiracy Theories, Linux, Opensource, IT, computer science, Unix, vlog, [★]">
        <meta http-equiv="Content-Language" content="en">
        <meta http-equiv="imagetoolbar" content="no">
        <meta name="format-detection" content="telephone=no">
        <meta name="author" content="tinfoil_hat">
        <title>Tinfoil-hat.net - A secure home for every tinfoil-hat.</title> 
    </head>
    <body>
        <!-- Border around content -->
        <div style="border:2px solid #555;border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-left-radius:5px;border-bottom-right-radius:5px;background-color:#000;box-s
hadow:3px 3px 5px rgba(0,0,0,0.5)">
            <!-- Headline -->
            <div style="text-shadow:1px 0px 0px #444;letter-spacing:0.28px;border-top-left-radius:10px;border-top-right-radius:10px;color:#fff;background-color:#111;padding:3px 6px 3px 6p
x;border-bottom:1px solid #555">
                 <!-- Headline Mobile -->
                 <div class="mobile-only"><b class="c-fff">Tinfoil-hat.net</b><br>A secure home for every tinfoil-hat</div>
                 <!-- Headline Desktop -->
                 <div class="desktop-only"><b class="c-fff">:: Tinfoil-hat.net - A secure home for every tinfoil-hat</b></div>
            </div>
            <!-- Menu -->
            	<div class="floatdiv"><a title="to Startpage" href="../index.html" style="color:#fff;border:0px">Start</a></div>
            	<div class="floatdiv"><a title="IT-Blog, References and Links" href="../cs/cs.html" style="color:#fff;border:0px">Computer Science</a></div>
            	<div class="floatdiv"><a title="Public Hosting" href="../hosting/hosting.html" style="color:#fff;border:0px">Public Hosting</a></div>
            	<div class="floatdiv"><a title="Anonymity" href="../privacy/structure.html" style="color:#fff;border:0px">Anonymity</a></div>
            	<div class="floatdiv"><a title="Call of Duty" href="../hacktivism/structure.html" style="color:#fff;border:0px">Hacktivism</a></div>
            	<div class="floatdiv"><a title="Conspiracy Theories" href="../ct/ct.html" style="color:#fff;border:0px">Conspiracy Theories</a></div>
            	<div class="floatdiv"><a title="Posts Overview" href="../posts/structure.html" style="color:#fff;border:0px">Posts Overview</a></div>

			<!-- Beginning Content -->
            <div style="padding:4px 7px 4px 7px;background-color:#000;clear:both">
            
                <!-- A -->
                        <div style="float:left;padding:0px 14px 7px 0px;max-width:640px;display:inline-block">

<p>In This Post I'm showing you How to create a Proxmox host which is reachable trough internet. It presupposes you have Proxmox already installed on your server:</p>
<h2 id="access-and-update-the-server">1. Access and Update the Server</h2>
<ol style="list-style-type: decimal">
<li>Create and copy your SSH Key</li>
<li>Connect with SSH Key</li>
<li>Upgrade Server</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> dist-upgrade -y</code></pre></div>
<hr />
<h2 id="harden-ssh">2. Harden SSH:</h2>
<ol style="list-style-type: decimal">
<li>Unstall UFW</li>
<li>Allow Port 22 (SSH Port) with Protocol TCP</li>
<li>Reload and activate UFW</li>
<li>Add User</li>
<li>install sudo</li>
<li>Add new user to sudo Group</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt-get</span> install ufw
<span class="ex">ufw</span> allow 22/tcp
<span class="ex">ufw</span> enable
<span class="ex">adduser</span> yourusername
<span class="ex">apt-get</span> install sudo
<span class="fu">sudo</span> adduser mynewuser sudo
<span class="fu">nano</span> /etc/ssh/sshd_config</code></pre></div>
<ul>
<li>Now edit / instert the following</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">PermitRootLogin</span> no
<span class="ex">MaxAuthTries</span> 6
<span class="ex">AllowUsers</span> yourusername
<span class="ex">PasswordAuthentication</span> no
<span class="ex">PermitEmptyPasswords</span> no
<span class="ex">PubkeyAuthentication</span> yes</code></pre></div>
<ul>
<li>Now reload SSH via:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">systemctl</span> restart sshd</code></pre></div>
<hr />
<h2 id="geoblocking-unwanted-visitors">3. Geoblocking unwanted Visitors:</h2>
<ul>
<li>Geoblock with: <a href="https://git.tinfoil-hat.net/tinfoil-hat/ip-backlist-china-and-russia">Russian Blocklist / China Blocklist</a></li>
</ul>
<h2 id="attention-run-in-screen-this-takes-a-large-amount-of-time">Attention: Run in screen, this takes a large amount of time!</h2>
<ol style="list-style-type: decimal">
<li>Install screen and git</li>
<li>Copy blacklist sources</li>
<li>Change directory to copied Sources</li>
<li>Create Screen session (if SSH session is interrupted the command doesn't cancel)</li>
<li>This is a while loop in Bash and will deny the connections from the IP adresses in this file. This step may take 1 to 2 hours to complete.
<ul>
<li>After you executed the command, you can send Screen to the Background with: CTRL+a+d</li>
</ul></li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt-get</span> install screen git
<span class="fu">git</span> clone https://git.tinfoil-hat.net/tinfoil-hat/ip-backlist-china-and-russia
<span class="bu">cd</span> ip-backlist-china-and-russia/
<span class="ex">screen</span> -S blocklist
<span class="kw">while</span> <span class="bu">read</span> <span class="va">line</span>; <span class="kw">do</span> <span class="fu">sudo</span> ufw deny from <span class="va">$line</span><span class="kw">;</span> <span class="kw">done</span> <span class="op">&lt;</span> <span class="ex">blocklist.txt</span> <span class="kw">&amp;&amp;</span> <span class="fu">bash</span> block_china_ufw.sh</code></pre></div>
<hr />
<h2 id="optional-make-ssh-port-accessable-only-via-vpn-connection-or-your-static-ip">4. (Optional) Make SSH Port accessable only via VPN Connection or your Static IP:</h2>
<ol style="list-style-type: decimal">
<li>Use / download Openvpn script: <a href="https://github.com/angristan/openvpn-install">angristan/openvpn-install</a></li>
<li>Change directory to Openvpn script</li>
<li>Make script executable</li>
<li>run Openvpn script</li>
<li>Allow SSH traffic from your OpenVPN connection</li>
<li>Allow SSH traffic from your Static IP Address (if you have one at home)</li>
<li>Change loglevel of your UFW so that the logfiles don't get gigantic.</li>
<li>Edit /etc/default/ufw</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">git</span> clone https://github.com/angristan/openvpn-install
<span class="bu">cd</span> openvpn-install/
<span class="fu">chmod</span> +x openvpn-install.sh
<span class="ex">./openvpn-install.sh</span>
<span class="ex">ufw</span> allow from  10.8.0.0/24  to any port 22
<span class="ex">ufw</span> allow from  *staticip*  to any port 22
<span class="ex">ufw</span> logging low
<span class="fu">nano</span> /etc/default/ufw</code></pre></div>
<ul>
<li>Allow troughput trough your VPN Connection and avoid getting no internet connection when you are connected with your VPN</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="va">DEFAULT_FORWARD_POLICY=</span><span class="st">&quot;ACCEPT&quot;</span></code></pre></div>
<ol start="9" style="list-style-type: decimal">
<li>edit /etc/network/interfaces</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">nano</span> /etc/network/interfaces</code></pre></div>
<ul>
<li>Add the following Text under your main Interface:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">    <span class="ex">post-up</span> echo 1 <span class="op">&gt;</span> /proc/sys/net/ipv4/ip_forward</code></pre></div>
<ul>
<li><em>This line will also allow you to access the Internet when connected trough your VPN</em></li>
</ul>
<hr />
<h2 id="convert-yor-debian-10-server-to-proxmox-6">5. Convert yor Debian 10 Server to Proxmox 6</h2>
<ol style="list-style-type: decimal">
<li>Add an /etc/hosts entry for your IP address</li>
</ol>
<ul>
<li>Note: Make sure that no IPv6 address for your hostname is specified in /etc/hosts.</li>
<li>For instance, if your IP address is 192.168.15.77, and your hostname prox4m1, then your /etc/hosts file should look like:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">127.0.0.1</span>       localhost.localdomain localhost
<span class="ex">192.168.15.77</span>   prox4m1.proxmox.com prox4m1

<span class="co"># The following lines are desirable for IPv6 capable hosts</span>
::<span class="ex">1</span>     localhost ip6-localhost ip6-loopback
<span class="ex">ff02</span>::1 ip6-allnodes
<span class="ex">ff02</span>::2 ip6-allrouters</code></pre></div>
<ul>
<li>You can test if your setup is ok using the hostname command:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">hostname</span> --ip-address
<span class="ex">192.168.15.77</span> <span class="co"># should return your IP address here</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Adapt your sources.list</li>
</ol>
<ul>
<li>Add the Proxmox VE repository:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">echo</span> <span class="st">&quot;deb http://download.proxmox.com/debian/pve buster pve-no-subscription&quot;</span> <span class="op">&gt;</span> /etc/apt/sources.list.d/pve-install-repo.list</code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Add the Proxmox VE repository key:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">wget</span> http://download.proxmox.com/debian/proxmox-ve-release-6.x.gpg -O /etc/apt/trusted.gpg.d/proxmox-ve-release-6.x.gpg
<span class="fu">chmod</span> +r /etc/apt/trusted.gpg.d/proxmox-ve-release-6.x.gpg  # optional, if you have a non-default umask</code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Update your repository and system by running:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt</span> full-upgrade</code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Install the Proxmox VE packages</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt</span> install proxmox-ve postfix open-iscsi</code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Recommended: remove the os-prober package</li>
</ol>
<ul>
<li>The os-prober package scans all the partitions of your host, including those assigned to guests VMs, to create dual-boot GRUB entries. If you didn't install Proxmox VE as dual boot beside another Operating System, you can safely remove the os-prober package.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt</span> remove os-prober</code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>Update and check grub2 config by running:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">update-grub</span></code></pre></div>
<h2 id="now-reboot">Now Reboot:</h2>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">reboot</span></code></pre></div>
<hr />
<h2 id="enter-proxmox-management-ui">6. Enter Proxmox Management UI</h2>
<ol style="list-style-type: decimal">
<li>Allow the Proxmox management Port (8006) to be open</li>
<li>Reload UFW</li>
<li>After that your Management Web Interface should be reachable in your Browser under https://your-ip-address:8006/</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ufw</span> allow 8006/tcp
<span class="ex">ufw</span> reload</code></pre></div>
<hr />
<h2 id="configure-proxmox">6. Configure Proxmox</h2>
<ol style="list-style-type: decimal">
<li>Edit the file /etc/network/interfaces</li>
</ol>
<ul>
<li>Paste the following (if your Main Interface is eth0)</li>
<li>Notice that I moved the Part <em>post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward</em> now from the Hardware Interface to the newly created Linux Bridge (vmbr1)</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">auto</span> vmbr1
<span class="ex">iface</span> vmbr1 inet static
        <span class="ex">address</span>  10.10.10.254
        <span class="ex">netmask</span>  255.255.255.0
        <span class="ex">bridge-ports</span> none
        <span class="ex">bridge-stp</span> off
        <span class="ex">bridge-fd</span> 0

        <span class="ex">dns-nameservers</span> 208.67.222.222 208.67.220.220

        <span class="ex">post-up</span> echo 1 <span class="op">&gt;</span> /proc/sys/net/ipv4/ip_forward

        <span class="ex">post-up</span> iptables -t nat -A POSTROUTING -s <span class="st">&#39;10.10.10.0/24&#39;</span> -o eth0 -j MASQUERADE
        <span class="ex">post-down</span> iptables -t nat -D POSTROUTING -s <span class="st">&#39;10.10.10.0/24&#39;</span> -o eth0 -j MASQUERADE</code></pre></div>
<h2 id="now-reboot-1">Now Reboot:</h2>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">reboot</span></code></pre></div>
<ul>
<li>Your Network Configuration in your Web Interface Should now look something like this:</li>
</ul>
<p><a href="/uploads/proxmox-bridge.png"><img src="https://wiki.tinfoil-hat.net/uploads/images/gallery/2019-10/scaled-1680-/Screenshot-from-2019-10-23-04-06-56.png" alt="Screenshot-from-2019-10-23-04-06-56.png" /></a></p>
<h1 id="to-be-continued-...">To be continued ...</h1>
                </div>
                <!-- A -->
                <div style="padding-bottom:2px;display:inline-block;width:420px;max-width:100%">
                    <div style="clear:both"></div>
                    <div style="font-size:6px"><br>
                                </div>
                
            </div>
            <!-- End Content -->
            <!-- Footer -->
            <div style="clear:both;font-size:11px;background-color:#00004d;border-bottom-left-radius:5px;border-bottom-right-radius:5px;color:#fff;padding:3px 6px 3px 6px;border-top:1px solid #555">
                <!-- Footer Content -->
                <a href=https://keyserver.ubuntu.com/pks/lookup?search=privat%40nchristian.net&fingerprint=on&op=index>GPG-Fingerprint: F1AB 723C 635B 792F E18A EED8 6259 5B76 EE31 15F2</a><span class="desktop-only"> ·</span><br class="mobile-only">
                <span class="desktop-only"></span><br class="mobile-only">
                <a target="_blank" href="https://git.tinfoil-hat.net/tinfoil-hat" style="color:#fff" rel="nofollow">Git Repo</a> ·</span><br class="mobile-only">
                <a href="irc://irc.uugrn.org:6668/uugrn" style="color:#fff" rel="nofollow">IRC #uugrn tinfoil-hat</a> ·</span><br class="mobile-only">
                <a style="color:#fff" rel="nofollow">chrissly90@jabber.nchristian.net</a> ·</span><br class="mobile-only">
                Mail:&nbsp;<span title="Do you have any questions or complains? E-Mail me!"><a href="mailto:mail@tinfoil-hat.net" style="color:#fff">mail@tinfoil-hat.net</a></span><span class="desktop-only"> ·</span><br class="mobile-only">
                <a href="legal.html" rel="nofollow">Legal</a> 
            </div>
            <!-- End Footer -->
            
        <!-- End Border around content -->
        </div>
    </body>
</html>

